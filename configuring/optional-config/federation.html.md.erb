---
title: Configuring Federation for Healthwatch
owner: Healthwatch
---

This topic describes how to configure federation for your Healthwatch installation.


## <a id='overview'></a> Overview of Federation

Healthwatch supports federation. When you configure your Healthwatch installation to federate
metrics, the Prometheus instance in the Healthwatch tile on a monitoring foundation, such as
the Ops Manager foundation that monitors other Ops Manager foundations or the Tanzu Kubernetes
Grid Integrated Edition (TKGI) Control Plane, scrapes a subset of metrics from the Prometheus
instances in the Healthwatch tiles installed on the foundations you monitor. This is useful
if you want to monitor a subset of metrics from multiple foundations without storing all metrics
from multiple foundations in a single Prometheus instance.

In a typical Healthwatch installation, you install the Healthwatch tile on the monitoring foundation
that you use to monitor other foundations, and you install either the Healthwatch Exporter
for VMware Tanzu Application Service for VMs (TAS for VMs) tile or the Healthwatch Exporter
for TKGI tile on each foundation you want to monitor. The Prometheus instance in the Healthwatch
tile on your monitoring foundation scrapes metrics from the Healthwatch Exporter tiles on each
foundation you monitor.

To configure federation for your Healthwatch installation, you install the Healthwatch tile
on your monitoring foundation and on each foundation you want to monitor, in addition to the
Healthwatch Exporter tile you install on each foundation you monitor. You then configure the
Healthwatch tile on each foundation you monitor to scrape metrics from the Healthwatch Exporter
tile installed on the same foundation, and the Healthwatch tile on your monitoring foundation
to scrape metrics from the Healthwatch tiles installed on the foundations you monitor.

For more information about federation, see [Federation](https://prometheus.io/docs/prometheus/latest/federation/)
in the Prometheus documentation.

<p class='note warning'><strong>Warning:</strong> Storing all Loggregator Firehose metrics
  from more than one large TAS for VMs foundation in a single Prometheus instance negatively
  affects the performance of that Prometheus instance, sometimes even causing it to crash.
  To avoid this, VMware recommends federating only service level indicator (SLI) metrics from
  each foundation you monitor to the Prometheus instance in your monitoring foundation.</p>


## <a id='federation-config'></a> Configure Federation

To configure federation your Healthwatch installation:

1. Install the Healthwatch tile on the foundation you use to monitor other foundations, such
as an Ops Manager foundation or the TKGI Control Plane. For more information, see [Installing
a Tile Manually](../../installing/installing-manually.html) or [Installing, Configuring, and
Deploying a Tile Through an Automated Pipeline](../../installing/automated-pipeline.html).

1. Install the Healthwatch tile and either the Healthwatch Exporter for TAS for VMs tile or
the Healthwatch Exporter for TKGI tile on each foundation you want to monitor. For more information,
see [Installing a Tile Manually](../../installing/installing-manually.html) or [Installing,
Configuring, and Deploying a Tile Through an Automated Pipeline](../../installing/automated-pipeline.html).

1. For each foundation you monitor, expose the TSDB instances in the Healthwatch tile
on port `4450`.

<p class='note info'><strong>Info:</strong> In the Highly Available configuration,
each TSDB VM is scraping the same exact data. When Federating, you can choose to
scrape both copies of that data into the monitoring foundation's Prometheus. In this case,
both TSDB instances from the monitored foundations would be used in the scrape config outlined below.

Another option would be to front the TSDB instances with an IAAS component for handling load balancing
between the two TSDB instances on the monitored foundations. This can accomplished either using DNS or a Load Balancer.
In both cases, it is recommended to use static IP addresses for both of the TSDB instances. For more information
about setting static IP addresses for the TSDB instances, see the [Configure Prometheus](../configuring-healthwatch.html#prometheus)
section of the Configuring Healthwatch docs.
</p>

1. For each foundation you want to monitor:
  1. Navigate to the Ops Manager Installation Dashboard for the foundation you want to monitor.
  1. Click the **Healthwatch** tile.
  1. Select the **Credentials** tab.
  1. In the **Tsdb Client mTLS** row, click **Link to Credential**.
  1. Record the credentials for **Tsdb Client mTLS**.
  1. Retrieve the Ops Manager root certificate authority (CA) for the foundation you want to
  monitor. For more information, see [Retrieve the Ops Manager Root CA](https://docs.pivotal.io/ops-manager/security/pcf-infrastructure/managing-certificates.html#root-certs)
  in _Managing Certificates with the Ops Manager API_ in the Ops Manager documentation.
  1. Navigate to the Ops Manager Installation Dashboard for your monitoring foundation.
  1. Click the **Healthwatch** tile.
  1. Select **Prometheus Configuration**.
  1. Under **Additional Scrape Config Jobs**, click **Add**.
  1. For **TSDB Scrape job**, provide the configuration YAML for a scrape job for the Prometheus
  instance in the Healthwatch tile on the foundation you want to monitor. In the example below,
  the scrape job federates all metrics with names that match the regular expression `^metric_name_regex.*`
  from the TSDB instance at the IP address listed under the `targets` property:

        ```
        job_name: example-job-name
        scheme: https
        metrics_path: '/federate'
        params:
          'match[]':
            - '{__name__=~"^metric_name_regex.*"}'
        static_configs:
          - targets:
            - 'source-tsdb-1:4450'
            - 'source-tsdb-2:4450'
        ```

        <p class='note info'><strong>Info:</strong>
        If you are using DNS or a Load Balancer in front of the TSDB instances, the Target list in the scrape config
        should point to that instead of the IP address of the TSDB instance.
        </p>

  1. For **TLS Config Certificate Authority**, enter the Ops Manager root CA from the foundation
  you want to monitor that you recorded in a previous step.
  1. For **TLS Config Certificate and Private Key**, enter the **Tsdb Client mTLS** credentials
  from the foundation you want to monitor that you recorded in a previous step.
  1. Click **Save**.
  <br>
  <br>
    If you are using the `om` CLI to configure the Healthwatch tile, the example below shows
    how you would enter the example configuration YAML above in an automation script:
    <%= partial '../../snippets/federation.md' %>
    For more information, see [Configure and Deploy Your Tile Using the om CLI](../../installing/automated-pipeline.html#om)
    in _Installing, Configuring, and Deploying a Tile Through an Automated Pipeline_.

  For more information about configuring scrape jobs, see [Prometheus Configuration](../configuring-healthwatch.html#prometheus)
  in _Configuring Healthwatch_ and [&#60;scrape_config>](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config)
  in _Configuration_ in the Prometheus documentation.
